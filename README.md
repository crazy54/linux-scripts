# AWS Python Runtime Upgrade Scripts

## Overview

This repository contains bash scripts to help automate the process of identifying and upgrading Python runtimes for AWS Lambda functions and AWS Systems Manager (SSM) Automation documents to a target Python version (e.g., Python 3.10).

The process typically involves two main scripts:
1.  `discover_resources.sh`: Scans specified AWS regions to find Lambda functions with outdated Python runtimes and all self-owned SSM Automation documents, outputting their ARNs to files.
2.  `upgrade_python_runtimes.sh`: Reads the ARN lists generated by the discovery script and simulates the process of updating their Python runtimes.

---

## Script: `discover_resources.sh`

### Purpose
`discover_resources.sh` scans one or more specified AWS regions to:
1.  Identify AWS Lambda functions that are using specific older Python runtimes.
2.  List all AWS Systems Manager (SSM) Automation documents owned by the caller's account.

It outputs the Amazon Resource Names (ARNs) of these resources into text files, which can then be used by `upgrade_python_runtimes.sh`.

### How to Use
1.  **Prerequisites**:
    *   AWS CLI installed and configured with necessary permissions (see below).
2.  **Execution**:
    ```bash
    chmod +x discover_resources.sh
    ./discover_resources.sh <region1> <region2> ...
    # Example: ./discover_resources.sh us-east-1 us-west-2 eu-central-1
    ```
    *   You must provide at least one AWS region as a command-line argument.
3.  **Outputs**:
    *   `lambda_functions_to_update.txt`: Contains ARNs of Lambda functions identified with outdated Python runtimes, across all specified regions.
    *   `ssm_automations_to_update.txt`: Contains ARNs of all self-owned SSM Automation documents, across all specified regions.
    *   `discover_resources.log`: Logs the script's operations.
4.  **Required AWS CLI Permissions**:
    *   `sts:GetCallerIdentity` (to get Account ID for constructing SSM ARNs)
    *   `lambda:ListFunctions` (for each specified region)
    *   `ssm:ListDocuments` (for each specified region)

### SSM Automation Discovery Limitation
**Important**: `discover_resources.sh` lists **all** self-owned SSM Automation documents. It **does not** filter these documents based on the Python runtime version used within their content. This is because determining the runtime requires fetching and parsing the content of each document, which is beyond the scope of this simple discovery script. You will need to manually review the `ssm_automations_to_update.txt` list or use a more advanced script if you only want to target SSM documents using specific Python versions.

---

## Script: `upgrade_python_runtimes.sh`

### Purpose
`upgrade_python_runtimes.sh` processes lists of Lambda function ARNs and SSM Automation document ARNs (as generated by `discover_resources.sh`) and performs (or simulates) the update of their Python runtimes to a configured target version.

### How to Use
1.  **Prerequisites**:
    *   AWS CLI installed and configured with necessary permissions (see below).
    *   Input files (`lambda_functions_to_update.txt`, `ssm_automations_to_update.txt`) populated, typically by `discover_resources.sh`.
2.  **Configure the Script (Optional)**:
    *   Open `upgrade_python_runtimes.sh`.
    *   `TARGET_PYTHON_RUNTIME` can be adjusted if needed (default is "python3.10").
3.  **Execution**:
    ```bash
    chmod +x upgrade_python_runtimes.sh
    ./upgrade_python_runtimes.sh
    ```
4.  **Outputs**:
    *   `upgrade_runtimes.log`: Logs the script's (simulated) update operations.
5.  **Required AWS CLI Permissions (for actual updates)**:
    *   `lambda:UpdateFunctionConfiguration` (for each function ARN)
    *   `ssm:GetDocument` (for each SSM document ARN, for the simulated update)
    *   `ssm:UpdateDocument` (for each SSM document ARN, if implementing actual updates)

### ARN Processing
This script reads ARNs from the input files. It extracts the resource name and region from each ARN to target the AWS CLI commands correctly.

### Simulation Aspects
*   **Lambda Updates**: The script is set up to execute `aws lambda update-function-configuration`. In a simulated environment (like the development of this script), these calls might be commented out or replaced by echo statements.
*   **SSM Automation Updates**: The process for updating SSM documents (fetching content, modifying runtime, updating document) is **highly simplified and simulated**. A production-ready solution for SSM document updates would require robust parsing and modification of the document structure (JSON/YAML), ideally using an AWS SDK like Boto3.

---

## Recommended Workflow

1.  **Discover Resources**:
    ```bash
    ./discover_resources.sh <region1> <region2> ...
    ```
    *   This populates `lambda_functions_to_update.txt` and `ssm_automations_to_update.txt` with ARNs.
    *   **Critically review `ssm_automations_to_update.txt`** due to the discovery limitations mentioned above. Manually edit this file to include only the SSM documents you intend to update.

2.  **Upgrade Runtimes**:
    *   Review `lambda_functions_to_update.txt`.
    *   Once you are satisfied with the content of both input files:
    ```bash
    ./upgrade_python_runtimes.sh
    ```
    *   Monitor `upgrade_runtimes.log` for progress and (simulated) results.

## General Prerequisites

*   **Bash Environment**: A Unix-like environment with bash.
*   **AWS CLI**: Ensure it is installed and configured. The specific permissions needed depend on which script and which operations (discovery vs. actual update) are being performed.

## Important Considerations & Limitations

*   **Testing**: **Thoroughly test these scripts in a non-production environment** before running them against critical resources.
*   **Error Handling**: The scripts include basic error checking but might not cover all edge cases.
*   **Idempotency**: The scripts are generally designed to be safe to re-run, but the actual idempotency of update operations depends on the AWS service behavior. Simulated updates are always "re-done".

## Files

*   `discover_resources.sh`: Script to discover resources across regions.
*   `upgrade_python_runtimes.sh`: Script to (simulate) upgrading runtimes from ARN lists.
*   `lambda_functions_to_update.txt`: Generated by `discover_resources.sh`, input for `upgrade_python_runtimes.sh`. Lists Lambda ARNs.
*   `ssm_automations_to_update.txt`: Generated by `discover_resources.sh`, input for `upgrade_python_runtimes.sh`. Lists SSM Automation ARNs.
*   `discover_resources.log`: Log file for `discover_resources.sh`.
*   `upgrade_runtimes.log`: Log file for `upgrade_python_runtimes.sh`.
*   `README.md`: This file.