# AWS Python Runtime Upgrade Scripts

## Overview

This repository contains bash scripts and a Python script to help automate the process of identifying and upgrading Python runtimes for AWS Lambda functions and AWS Systems Manager (SSM) Automation documents to a target Python version (e.g., Python 3.10).

The process typically involves three main scripts:
1.  `discover_resources.sh`: Scans specified AWS regions to find Lambda functions with outdated Python runtimes and all self-owned SSM Automation documents, outputting their ARNs to files.
2.  `filter_ssm_documents.py`: Processes the list of SSM document ARNs from the discovery step, inspects their content, and filters out those that do not use outdated Python runtimes in `aws:executeScript` steps.
3.  `upgrade_python_runtimes.sh`: Reads the ARN lists (the Lambda list from discovery, and the filtered SSM list) and simulates the process of updating their Python runtimes.

---

## Script: `discover_resources.sh`

### Purpose
`discover_resources.sh` scans one or more specified AWS regions to:
1.  Identify AWS Lambda functions that are using specific older Python runtimes.
2.  List all AWS Systems Manager (SSM) Automation documents owned by the caller's account.

It outputs the Amazon Resource Names (ARNs) of these resources into text files.

### How to Use
1.  **Prerequisites**:
    *   AWS CLI installed and configured.
2.  **Execution**:
    ```bash
    chmod +x discover_resources.sh
    ./discover_resources.sh <region1> <region2> ...
    ```
3.  **Outputs**:
    *   `lambda_functions_to_update.txt`: Contains ARNs of Lambda functions identified with outdated Python runtimes.
    *   `ssm_automations_to_update.txt`: Contains ARNs of ALL self-owned SSM Automation documents. This file is input for `filter_ssm_documents.py`.
    *   `discover_resources.log`: Logs the script's operations.

### SSM Automation Discovery Limitation
**Important**: `discover_resources.sh` lists **all** self-owned SSM Automation documents. It **does not** filter these documents based on the Python runtime version used within their content. This initial broad list is then processed by `filter_ssm_documents.py`.

---

## Script: `filter_ssm_documents.py`

### Purpose
`filter_ssm_documents.py` refines the list of SSM Automation document ARNs produced by `discover_resources.sh`. It inspects the content of each SSM document (using AWS Boto3 SDK) to determine if it actually uses an outdated Python runtime in any of its `aws:executeScript` steps.

### How to Use
1.  **Prerequisites**:
    *   Python 3.x installed.
    *   Boto3 library installed (`pip install boto3`).
    *   AWS credentials configured for Boto3 (environment variables, shared credentials file, or IAM roles).
    *   `ssm_automations_to_update.txt` must exist (generated by `discover_resources.sh`).
2.  **Execution**:
    ```bash
    chmod +x filter_ssm_documents.py
    python3 filter_ssm_documents.py [options]
    ```
    *   Run `python3 filter_ssm_documents.py --help` for options like specifying input/output files and log level.
3.  **Inputs**:
    *   Default input file: `ssm_automations_to_update.txt`.
4.  **Outputs**:
    *   Default output file: `ssm_automations_filtered.txt`. This file contains ARNs of SSM documents confirmed to use outdated Python runtimes. This file is then used by `upgrade_python_runtimes.sh`.
    *   Console output with logging information.

---

## Script: `upgrade_python_runtimes.sh`

### Purpose
`upgrade_python_runtimes.sh` processes lists of Lambda function ARNs (from `discover_resources.sh`) and filtered SSM Automation document ARNs (from `filter_ssm_documents.py`) and performs (or simulates) the update of their Python runtimes to a configured target version.

### How to Use
1.  **Prerequisites**:
    *   AWS CLI installed and configured.
    *   Input files:
        *   `lambda_functions_to_update.txt` (populated by `discover_resources.sh`).
        *   `ssm_automations_filtered.txt` (populated by `filter_ssm_documents.py`).
2.  **Execution**:
    ```bash
    chmod +x upgrade_python_runtimes.sh
    ./upgrade_python_runtimes.sh
    ```
3.  **Outputs**:
    *   `upgrade_runtimes.log`: Logs the script's (simulated) update operations.

### ARN Processing & Simulation Aspects
(Content mostly unchanged from previous README, emphasizing simulation)
This script reads ARNs from the input files. It extracts the resource name and region from each ARN to target the AWS CLI commands correctly.
The update operations are **simulated** by default. To perform actual updates, the script would need to be modified to execute live AWS CLI commands.

---

## Recommended Workflow

1.  **Discover Resources**:
    ```bash
    ./discover_resources.sh <region1> <region2> ...
    ```
    *   This populates `lambda_functions_to_update.txt` and the initial `ssm_automations_to_update.txt`.

2.  **Filter SSM Automations**:
    ```bash
    python3 filter_ssm_documents.py
    ```
    *   This reads `ssm_automations_to_update.txt` and creates `ssm_automations_filtered.txt` containing only SSM documents confirmed to use outdated Python.
    *   Review the logs and `ssm_automations_filtered.txt`.

3.  **Upgrade Runtimes (Simulated)**:
    *   Review `lambda_functions_to_update.txt`.
    *   Once satisfied with both `lambda_functions_to_update.txt` and `ssm_automations_filtered.txt`:
    ```bash
    ./upgrade_python_runtimes.sh
    ```
    *   Monitor `upgrade_runtimes.log` for progress and (simulated) results.

## General Prerequisites

*   **Bash Environment**: A Unix-like environment with bash.
*   **AWS CLI**: For `discover_resources.sh` and `upgrade_python_runtimes.sh`.
*   **Python 3.x and Boto3**: For `filter_ssm_documents.py`.

## Important Considerations & Limitations
(Content mostly unchanged, still relevant)
*   **Testing**: **Thoroughly test these scripts in a non-production environment.**
*   **Error Handling**: The scripts include basic error checking.
*   **SSM Update Complexity**: Actual SSM document updates are complex and best handled with robust parsing (e.g., via SDKs), which `filter_ssm_documents.py` uses for inspection but `upgrade_python_runtimes.sh` only simulates for update.

## Files

*   `discover_resources.sh`: Script to discover resources.
*   `filter_ssm_documents.py`: Python script to filter SSM documents by runtime in content.
*   `upgrade_python_runtimes.sh`: Script to (simulate) upgrading runtimes.
*   `lambda_functions_to_update.txt`: Generated by `discover_resources.sh`.
*   `ssm_automations_to_update.txt`: Generated by `discover_resources.sh`, input for `filter_ssm_documents.py`.
*   `ssm_automations_filtered.txt`: Generated by `filter_ssm_documents.py`, input for `upgrade_python_runtimes.sh`.
*   `discover_resources.log`: Log file for `discover_resources.sh`.
*   `upgrade_runtimes.log`: Log file for `upgrade_python_runtimes.sh`.
*   `README.md`: This file.
